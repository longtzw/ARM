# 第1章 ARM概述及基本编程模型

## 1.1 ARM处理器模式

ARM处理器共有7种运行模式，如表1.1所示。

**表1.1**

处理器模式                    |描述
------------------------------|-------------------------
用户模式(User)                |正常程序执行的模式
快速中断模式(FIQ)             |用于高速数据传输和处理
外部中断模式(IRQ)             |用于通常的中断处理
特权模式(Supervisor)          |供操作系统使用的一种保护模式
数据访问终止模式(Abort)       |用于虚拟存储及存储保护
未定义指令中止模式(Undefined) |用于支持通过软件仿真硬件的协处理器
系统模式(System)              |用于运行特权级的操作系统任务

除了用户模式之外的6种处理器模式称为特权模式。在这些模式下，程序可以访问所有的系统资源，也可以任意进行处理器模式切换。其中，除系统模式外，其它5种特权模式又称为异常模式。

大多数的用户程序运行在用户模式下。当需要进行处理器模式切换时应用程序可以产生异常处理，在异常处理中进行模式切换。

每一种异常模式中都有一组寄存器，供相应的异常处理程序使用，这样可以保证在进入异常模式时，用户模式下的寄存器不被破坏。

系统模式并不是通过异常进入的，它和用户模式具有完全一样的寄存器，但它可以访问所有的系统资源，它主要供操作系统使用。

## 1.2 ARM寄存器介绍

表1.2列出了各处理器模式下可见的寄存器情况。

**表1.2**

用户模式 | 系统模式 | 特权模式 | 中止模式 | 未定义指令模式 | 外部中断模式 | 快速中断模式
---------|----------|----------|----------|----------------|--------------|-------------
R0       |R0        |R0        |R0        |R0              |R0            |R0  
R1       |R1        |R1        |R1        |R1              |R1            |R1  
R2       |R2        |R2        |R2        |R2              |R2            |R2  
R3       |R3        |R3        |R3        |R3              |R3            |R3  
R4       |R4        |R4        |R4        |R4              |R4            |R4  
R5       |R5        |R5        |R5        |R5              |R5            |R5  
R6       |R6        |R6        |R6        |R6              |R6            |R6  
R7       |R7        |R7        |R7        |R7              |R7            |R7  
R8       |R8        |R8        |R8        |R8              |R8            |R8_fiq 
R9       |R9        |R9        |R9        |R9              |R9            |R9_fiq  
R10      |R10       |R10       |R10       |R10             |R10           |R10_fiq  
R11      |R11       |R11       |R11       |R11             |R11           |R11_fiq  
R12      |R12       |R12       |R12       |R12             |R12           |R12_fiq  
R13      |R13       |R13_svc   |R13_abt   |R13_und         |R13_irq       |R13_fiq  
R14      |R14       |R14_svc   |R14_abt   |R14_und         |R14_irq       |R14_fiq  
PC       |PC        |PC        |PC        |PC              |PC            |PC  
CPSR     |CPSR      |CPSR      |CPSR      |CPSR            |CPSR          |CPSR  
         |          |SPSR_svc  |SPSR_abt  |SPSR_und        |SPSR_irq      |SPSR_fiq

### 1.2.1 通用寄存器

通用寄存器可以分为下面3类：

- 未备份寄存器(The unbanked registers), R0~R7
- 备份寄存器(The banked registers), R8~R14
- 程序计数器PC, R15

R13在ARM中常用作堆栈指针，每一种异常模式拥有自己的物理R13。应用程序初始化它，使其指向该异常模式专用的栈地址。R14又被称为连接寄存器(Link Register, LR)。对于ARM指令集来说，PC指向当前指令的下面两条指令的地址，由于ARM指令是字节对齐的，PC值的第0位和第1位总是0。

### 1.2.2 程序状态寄存器

CPSR(当前程序状态寄存器)可以在任何处理器模式下被访问。它包含了条件标志位、中断禁止位、当前处理器模式标志以及其他的一些控制和状态位。每一种处理器模式下都有一个专用的物理状态寄存器，称为SPSR(备份程序状态寄存器)。当特定的异常中断发生时，这个寄存器用于存放当前程序状态寄存器的内容。异常恢复时，可以用SPSR中保存的值来恢复CPSR。

## 1.3 ARM体系中的存储系统

### 1.3.1 ARM存储器格式

![大小端](http://img.hb.aicdn.com/0cc93b52d8b9cb168cb5fa861b83f44163537683c113-j4zh4H)

### 1.3.2 非对齐的存储访问

在ARM中，通常希望字单元的地址是字对其的(地址的低两位为00)，半字单元的地址是半字对齐的(地址最低位为0)。在存储访问中，如果存储单元的地址没有遵守上述的对齐规则，则称为非对其的存储访问操作。

#### 1.3.2.1 非对齐的指令预取操作

若ARM状态期间，写入到寄存器PC中的值非字对齐，或Thumb状态期间，写入寄存器PC中的值非半字对齐，则，要么执行指令的结果不可预知，要没地址值中最低位被忽略。若是后者，则由存储系统实现这种“忽略”。也就是说，这时该地址值原封不动地送回存储系统。

#### 1.3.2.2 非对齐数据访问操作

对于 Load/Store操作，如果是非对齐的数据访问操作，系统定义了下面3种可能的结果：

- 执行结果不可预知
- 访问(address AND 0xfffffffc)或(address AND 0xfffffffe)
- 忽略本次操作

